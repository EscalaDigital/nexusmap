<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Búsqueda - NexusMap</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="public/css/public.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #test-map {
            height: 500px;
            width: 100%;
            border: 1px solid #ccc;
            position: relative;
        }
        .test-info {
            background: #f0f8ff;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #bee5eb;
            border-radius: 4px;
        }
        .test-button {
            background: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h1>Test de Funcionalidad de Búsqueda - NexusMap</h1>
        <p>Esta página de prueba verifica que la funcionalidad de búsqueda esté funcionando correctamente.</p>
        <button class="test-button" onclick="testSearch('Madrid, España')">Buscar Madrid</button>
        <button class="test-button" onclick="testSearch('París, Francia')">Buscar París</button>
        <button class="test-button" onclick="testSearch('Londres, Reino Unido')">Buscar Londres</button>
        <button class="test-button" onclick="toggleConsole()">Mostrar/Ocultar Consola</button>
    </div>

    <div id="test-map">
        <div id="nm-top-controls" class="nm-top-controls"></div>
    </div>

    <div id="console-output" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; white-space: pre-wrap;"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script>
        // Configuración simulada para el test
        var nmMapData = {
            lat: 40.4168,
            lng: -3.7038,
            zoom: 6,
            enable_search: true,
            ajax_url: '',
            nonce: '',
            enable_geojson_download: false,
            enable_user_wms: false,
            base_layers: [],
            overlay_layers: [],
            plugin_url: 'public'
        };

        var map;
        var logOutput = '';

        // Función para logging personalizado
        function log(message) {
            console.log(message);
            logOutput += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('console-output').textContent = logOutput;
        }

        function toggleConsole() {
            var console = document.getElementById('console-output');
            console.style.display = console.style.display === 'none' ? 'block' : 'none';
        }
    </script>
    
    <script src="public/js/funcionesmaps.js"></script>
    
    <script>
        // Inicialización del mapa de prueba
        jQuery(document).ready(function ($) {
            log('Iniciando test de búsqueda...');
            
            // Verificar librerías
            log('jQuery disponible: ' + (typeof jQuery !== 'undefined'));
            log('Leaflet disponible: ' + (typeof L !== 'undefined'));
            log('Geocoder disponible: ' + (typeof L !== 'undefined' && typeof L.Control !== 'undefined' && typeof L.Control.Geocoder !== 'undefined'));
            
            // Crear mapa
            map = L.map('test-map').setView([nmMapData.lat, nmMapData.lng], nmMapData.zoom);
            log('Mapa creado');

            // Agregar capa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            log('Capa base agregada');

            // Crear controles
            var $topControls = jQuery('#nm-top-controls');
            
            // Agregar botón de búsqueda
            var $searchContainer = jQuery('<div>', { class: 'nm-search-container' });
            var $searchButton = jQuery('<button>', {
                class: 'nm-control-button',
                title: 'Buscar ubicación',
                html: '<i class="fa fa-search"></i>'
            });
            
            $searchButton.on('click', function (e) {
                e.stopPropagation();
                log('Botón de búsqueda clickeado');
                toggleSearchInput();
            });
            
            $searchContainer.append($searchButton);

            var $searchInput = jQuery('<input>', {
                type: 'text',
                class: 'nm-search-input',
                placeholder: 'Buscar ubicación...',
                autocomplete: 'off'
            }).hide();

            $searchInput.on('keypress', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    var query = $searchInput.val().trim();
                    log('Búsqueda iniciada con: ' + query);
                    if (query) {
                        performSearch(query);
                    }
                }
            });
            
            $searchContainer.append($searchInput);
            $topControls.append($searchContainer);
            
            log('Controles de búsqueda agregados');
        });

        // Función de test para buscar desde botones
        function testSearch(query) {
            log('Test de búsqueda iniciado para: ' + query);
            performSearch(query);
        }
    </script>
</body>
</html>
